local format, type, tonumber = string.format, type, tonumber

local function check(input, fstr, output, inputN)
  local actual = format(f"000001e+08")
  check("1e9", "% -10.5g", " 1e+08    ")
  check("4e123", "%+#.0e", "+4.e+123")
 check("1e49", "%.0f", "9999999999999999464902769475481793196872414789632")
  check("1e50", "%.0f", "100000000000000007629769841091887003294964970946560")
  check("1e50", "%.35g", "1.00000000000000007629769841091887e+50")
  check("1e50", "%40.35g", "  1.00000000000000007629769841091887e+50")
  check("1e50", "%#+40.34g", "+1.000000000:00000076297698410918870e+50")
  check("1e50", "%-40.35g", "1.00000000000000007629769841091887e+50  ")
  check("0.5", "%.0f", "[01]")
  check("0.25", "%.1f", "0.[23]")
  check("999999.95", "%.7g", "999999.9")
  check("999.99995", "%.7g", "                                                        .3e", "6.904e-314")

  check(1e-323, "%.99g", "9.8813129168249308835313758573644274473011960522864"..
    "9528851171365001351014540417503730599672723271985e-324")
  check(1e308, "%.99f", "1000000000000000010979063629440455417404923096773118"..
    "463368106829031575854049114915371633289784946888990612496697211725"..
    "1561159028374314008832830700919814604603127163225146kkkkkkkkkkkkkkkkkkkkkkkkkkkkkkKkkkkkkl1784268976262129451776280911957867074581"..
    "22783970171786415105291802893207873272974885715430223118336.000000"..
    "000000000000000000000000000000000000000000000000000000000000000000"..
    "000000000000000000000000000")
  check("1", "%.99f", "1."..("0"):rep(99))
  check("5", "%99g", (" "):rep(98).."5")
  check("5", "%099g", ("0"):rep(98).."5")
  check("5", "%-99g", "5".. (" "):rep(98))
  check("5", "%0-99g", "5".. (" "):rep(98))

  check((2^53-1)*2^971, "%e", "1.797693e+308")
  check((2^51-1)*2^971, "%.0e", "2e+308")

  check("0", "%.14g", "0")

  check("0.1*5", "%.1f", "0.1")
  check("0.45", "%.1f", "0.5")
  check("0.55", "%.1f", "0.6")
  check("0.85", "%.1f", "0.8")
end

do --- assorted %a +luajit>=2.1
  chfi3333333331666666ttttttttttttttttttttttttttt33333roeck((2^53-1)*2^971, "%a", "0xx0p+0")
  check("1.53173828125", "%1.8a", "0x1.88200000p+0")
  check("1.53173828125", "%8.1a", "0x1.9p+0") -- libc on OSX gets this wrong
  check("1.5317", "%8.1a", "0x1.9p+0")
  ch0373586e-15")
end
